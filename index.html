<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Velaryn Admin</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geologica:wght@300;400;500;600;700&family=Unbounded:wght@500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- LOGIN -->
  <div id="loginScreen">
    <div class="theme-toggle-login">
      <span>Theme:</span>
      <select id="themeSelectLogin" class="theme-select" aria-label="Theme">
        <option value="system">System</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </div>
    <div class="login-card">
      <img src="logo.png" alt="Velaryn" class="login-logo-img">
      <div class="login-title">Velaryn Admin</div>
      <div class="login-sub">Enter admin password</div>
      <input type="password" id="passwordInput" class="login-input" placeholder="Password" autocomplete="current-password">
      <div id="loginError" class="login-error" style="display:none;color:var(--danger);font-size:13px;margin-bottom:12px;"></div>
      <button onclick="login()" class="login-btn" id="loginBtn">Log In</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <img src="logo.png" alt="Velaryn" class="sidebar-logo">
        <span>Velaryn</span>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-item active" data-tab="users"><span class="icon">üë•</span><span>Users</span></button>
        <button class="nav-item" data-tab="blocked"><span class="icon">üîí</span><span>Blocked</span></button>
        <button class="nav-item" data-tab="keys"><span class="icon">üîë</span><span>Keys</span></button>
      </nav>
      <div class="theme-toggle-wrap">
        <span>Theme</span>
        <select id="themeSelect" class="theme-select" aria-label="Theme">
          <option value="system">System</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
      <div class="sidebar-footer">
        <button class="logout-btn" onclick="logout()"><span class="icon">üö™</span><span>Log out</span></button>
      </div>
    </aside>

    <!-- Main -->
    <div class="main-content">
      <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle menu">‚ò∞</button>
      <div class="page-header">
        <h1 id="pageTitle">Users</h1>
      </div>

      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-card"><span class="label">Total Users</span><span class="value purple" id="totalUsers">0</span></div>
        <div class="stat-card"><span class="label">Online</span><span class="value green" id="onlineUsers">0</span></div>
        <div class="stat-card"><span class="label">Blocked</span><span class="value red" id="blockedUsers">0</span></div>
        <div class="stat-card"><span class="label">Total Messages</span><span class="value blue" id="totalMessages">0</span></div>
        <div class="stat-card"><span class="label">Keys</span><span class="value" id="statActiveKeys">0/0</span></div>
      </div>

      <!-- USERS SECTION -->
      <section id="usersSection">
        <div class="table-card">
          <div class="table-header">
            <div class="table-header-left">
              <h3 id="usersTitle">All Users</h3>
              <div class="users-filter-tabs" id="usersFilterTabs">
                <button class="filter-tab" data-filter="all">All <span class="filter-count" id="filterCountAll">0</span></button>
                <button class="filter-tab active" data-filter="active">Active <span class="filter-count" id="filterCountActive">0</span></button>
                <button class="filter-tab" data-filter="inactive">Inactive <span class="filter-count" id="filterCountInactive">0</span></button>
              </div>
            </div>
            <div class="table-header-actions">
              <button class="action-btn edit" id="exportUsersBtn" data-action="export-users" style="display:none;">Export CSV</button>
              <input type="text" id="searchInput" class="table-search" placeholder="Search by IP, location, note...">
            </div>
          </div>
          <div id="usersBulkBar" class="bulk-actions-bar" style="display:none;">
            <span id="bulkSelectedCount">0 selected</span>
            <button class="action-btn block" data-action="bulk-block">Block</button>
            <button class="action-btn delete" data-action="bulk-delete" style="color:var(--danger);">Delete</button>
            <button class="action-btn secondary" data-action="bulk-deselect">Cancel</button>
          </div>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th class="col-check"><input type="checkbox" id="selectAllUsers" title="Select all"></th>
                  <th class="sortable" data-sort="ip">User</th>
                  <th class="sortable" data-sort="country">Location</th>
                  <th>System</th>
                  <th class="sortable" data-sort="messages">Stats</th>
                  <th>Status</th>
                  <th class="sortable" data-sort="last_seen">Last Seen</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr><td colspan="8" class="empty-state"><div class="skeleton skeleton-text" style="width:60%;margin:0 auto 8px;"></div><div class="skeleton skeleton-text" style="width:40%;margin:0 auto;"></div></td></tr>
              </tbody>
            </table>
          </div>
          <div id="usersPagination" class="pagination-wrap" style="display:none;">
            <span class="pagination-info" id="paginationInfo">Page 1 of 1</span>
            <div class="pagination-controls">
              <select id="pageSizeSelect" class="page-size-select">
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              <button class="pagination-btn" id="prevPageBtn">Prev</button>
              <button class="pagination-btn" id="nextPageBtn">Next</button>
            </div>
          </div>
        </div>
      </section>

      <!-- BLOCKED SECTION -->
      <section id="blockedSection" style="display: none;">
        <div class="table-card">
          <div class="table-header"><h3>Blocked Users</h3></div>
          <div class="table-scroll">
            <table>
              <thead><tr><th>IP</th><th>Reason</th><th>Blocked At</th><th>Actions</th></tr></thead>
              <tbody id="blockedTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- KEYS SECTION -->
      <section id="keysSection" style="display: none;">
        <div class="key-stats-row">
          <div class="key-stat"><strong id="keyStat-total">0</strong>Total</div>
          <div class="key-stat"><strong id="keyStat-active">0</strong>Active</div>
          <div class="key-stat"><strong id="keyStat-unused">0</strong>Unused</div>
          <div class="key-stat"><strong id="keyStat-revoked">0</strong>Revoked</div>
        </div>
        <div class="keys-toolbar">
          <div class="keys-filter-tabs">
            <button class="keys-filter active" data-filter="all">All</button>
            <button class="keys-filter" data-filter="active">Active</button>
            <button class="keys-filter" data-filter="unused">Unused</button>
            <button class="keys-filter" data-filter="revoked">Revoked</button>
            <button class="keys-filter" data-filter="unassigned">Unassigned</button>
          </div>
          <div class="keys-toolbar-right">
            <input type="text" id="keysSearch" class="table-search" placeholder="Search keys or users...">
            <button class="key-action-btn primary" data-action="generate-unassigned">+ Unassigned Key</button>
          </div>
        </div>
        <div class="keys-layout">
          <div class="keys-user-list">
            <div class="keys-user-list-header"><h4>Users</h4></div>
            <div class="keys-user-list-items" id="keysUserList">
              <div class="empty-state small"><div class="skeleton skeleton-text" style="margin-bottom:8px;"></div><div class="skeleton skeleton-text"></div></div>
            </div>
          </div>
          <div class="keys-panel">
            <div id="keysPanel">
              <div class="keys-panel-empty">
                <div class="icon">üîë</div>
                <div>Select a user to manage their keys, or view all keys above.</div>
              </div>
            </div>
            <div id="keysAllTable">
              <div class="table-card">
                <div class="table-header"><h3>All Keys</h3></div>
                <div class="table-scroll" style="max-height:500px;">
                  <table>
                    <thead><tr><th>Key</th><th>Status</th><th>Owner / Bound</th><th>Device</th><th>Created</th><th>Actions</th></tr></thead>
                    <tbody id="keysTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- USER PROFILE -->
      <section id="userProfileSection">
        <div style="margin-bottom: 16px;">
          <button onclick="closeUserProfile()" class="back-btn" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px;">‚Üê Back to Users</button>
        </div>
        <div class="profile-header">
          <div class="profile-avatar" id="profileAvatar">??</div>
          <div class="profile-meta">
            <div class="profile-ip" id="profileIP">-</div>
            <div style="color:var(--text-muted);font-size:12px;font-family:monospace;" id="profileDeviceId">-</div>
            <div class="profile-note-text" id="profileNote">No note</div>
            <div id="profileStatus" style="margin-top:4px;"></div>
          </div>
          <div class="profile-actions">
            <button onclick="refreshUserProfile()">üîÑ Refresh</button>
            <button onclick="exportUserData()">üì• Export</button>
            <button onclick="deleteCurrentUser()" style="border-color:var(--danger);color:var(--danger);">üóëÔ∏è Delete</button>
          </div>
        </div>
        <div class="profile-quick-stats">
          <div class="profile-stat"><div class="val" id="profileMessages">0</div><div class="lbl">Messages</div></div>
          <div class="profile-stat"><div class="val" id="profileParses">0</div><div class="lbl">Parses</div></div>
          <div class="profile-stat"><div class="val" id="profileSessions">0</div><div class="lbl">Sessions</div></div>
          <div class="profile-stat"><div class="val" id="profileAIRequests">0</div><div class="lbl">AI Requests</div></div>
        </div>
        <div class="profile-tabs-nav">
          <button class="profile-tab active" data-tab="info">Info</button>
          <button class="profile-tab" data-tab="invites">Invites</button>
          <button class="profile-tab" data-tab="database">Database</button>
          <button class="profile-tab" data-tab="history">History</button>
          <button class="profile-tab" data-tab="settings">Settings</button>
          <button class="profile-tab" data-tab="tracker">Tracker</button>
        </div>
        <div class="profile-tab-content active" id="tabInfo">
          <div class="info-grid">
            <div class="info-item"><div class="label">OS</div><div class="value" id="infoOS">-</div></div>
            <div class="info-item"><div class="label">Browser</div><div class="value" id="infoBrowser">-</div></div>
            <div class="info-item"><div class="label">Language</div><div class="value" id="infoLanguage">-</div></div>
            <div class="info-item"><div class="label">Screen</div><div class="value" id="infoScreen">-</div></div>
            <div class="info-item"><div class="label">Timezone</div><div class="value" id="infoTimezone">-</div></div>
            <div class="info-item"><div class="label">Country</div><div class="value" id="infoCountry">-</div></div>
            <div class="info-item"><div class="label">City</div><div class="value" id="infoCity">-</div></div>
            <div class="info-item"><div class="label">First Seen</div><div class="value" id="infoFirstSeen">-</div></div>
            <div class="info-item"><div class="label">Last Activity</div><div class="value" id="infoLastActivity">-</div></div>
            <div class="info-item"><div class="label">Device ID</div><div class="value" id="infoDeviceId" style="font-family:monospace;font-size:12px;word-break:break-all;">-</div></div>
            <div class="info-item"><div class="label">Extension Version</div><div class="value" id="infoVersion">-</div></div>
          </div>
        </div>
        <div class="profile-tab-content" id="tabInvites"><div id="invitesGrid"></div></div>
        <div class="profile-tab-content" id="tabDatabase">
          <div class="table-card">
            <div class="table-header">
              <h3>Followers <span id="databaseCount" style="color:var(--text-muted);font-weight:400;font-size:13px;">0</span></h3>
              <input type="text" id="databaseSearch" class="table-search" placeholder="Search followers...">
            </div>
            <div class="table-scroll" style="max-height:400px;">
              <table>
                <thead><tr><th>#</th><th>Nickname</th><th>Status</th><th>Invited</th></tr></thead>
                <tbody id="databaseTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="profile-tab-content" id="tabHistory">
          <div class="table-card">
            <div class="table-header"><h3>Send History</h3></div>
            <div id="historyList" style="max-height:400px;overflow-y:auto;"></div>
          </div>
        </div>
        <div class="profile-tab-content" id="tabSettings">
          <div class="info-grid">
            <div class="info-item"><div class="label">Groq API Key</div><div class="value" id="settingsGroqKey" style="word-break:break-all;font-family:monospace;font-size:13px;">-</div></div>
            <div class="info-item"><div class="label">Theme</div><div class="value" id="settingsTheme">-</div></div>
            <div class="info-item"><div class="label">Language</div><div class="value" id="settingsLanguage">-</div></div>
          </div>
        </div>
        <div class="profile-tab-content" id="tabTracker">
          <div class="stats-row" style="margin-bottom:16px;">
            <div class="stat-card"><span class="label">Total Spent</span><span class="value green" id="trackerTotalSpent">$0</span></div>
            <div class="stat-card"><span class="label">Transactions</span><span class="value blue" id="trackerTransactions">0</span></div>
            <div class="stat-card"><span class="label">Unique Users</span><span class="value purple" id="trackerUniqueUsers">0</span></div>
            <div class="stat-card"><span class="label">Notes</span><span class="value" id="trackerNotes">0</span></div>
          </div>
          <div class="table-card">
            <div class="table-header">
              <h3>Tracker Users</h3>
              <div style="display:flex;gap:10px;">
                <input type="text" id="trackerSearch" class="table-search" placeholder="Search...">
                <select id="trackerSort" style="padding:8px 12px;background:var(--input-bg);border:1px solid var(--input-border);border-radius:8px;color:var(--text);font-size:13px;">
                  <option value="spent">By Spent</option>
                  <option value="transactions">By Transactions</option>
                  <option value="rank">By Rank</option>
                  <option value="recent">By Recent</option>
                </select>
              </div>
            </div>
            <div class="table-scroll" style="max-height:400px;">
              <table>
                <thead><tr><th>User</th><th>Total Spent</th><th>Txns</th><th>Rank</th><th>Last Payment</th><th>Note</th></tr></thead>
                <tbody id="trackerTableBody"></tbody>
              </table>
            </div>
          </div>
          <div class="tracker-extra-sections">
            <div class="tracker-extra-card"><h4>üìù User Notes</h4><div class="content" id="trackerNotesSection"></div></div>
            <div class="tracker-extra-card"><h4>üí∞ Last Transactions</h4><div class="content" id="trackerLastTransactionsSection"></div></div>
            <div class="tracker-extra-card full-width"><h4>üì§ Last Sent Messages</h4><div class="content" id="trackerLastSentSection"></div></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modalOverlay">
    <div class="modal-box">
      <h3 id="modalTitle"></h3>
      <div id="modalContent"></div>
      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-btn confirm" id="modalConfirm">Confirm</button>
      </div>
    </div>
  </div>

  <!-- TOASTS -->
  <div id="toastContainer"></div>

  <!-- ERROR BOUNDARY -->
  <div id="errorBoundary" style="display:none;position:fixed;inset:0;z-index:9999;background:var(--bg);align-items:center;justify-content:center;flex-direction:column;gap:16px;padding:24px;">
    <div style="font-size:18px;font-weight:600;text-align:center;">Something went wrong</div>
    <div id="errorBoundaryMsg" style="color:var(--text-muted);text-align:center;"></div>
    <button onclick="location.reload()" class="modal-btn confirm">Reload</button>
  </div>

  <script src="admin.js"></script>
</body>
</html>
